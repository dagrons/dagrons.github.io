<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="zh_cn">
<head>
<meta charset="utf-8">
<meta name="description" content="NuLL">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NuLL</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="zh_cn" href="rss.xml">
<link rel="canonical" href="https://dagrons.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/goxue-xi-di-er-tian-zi-fu-chuan-xiang-guan/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">跳到主内容</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">NuLL</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">文章归档</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">标签</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS 源</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/goxue-xi-di-er-tian-zi-fu-chuan-xiang-guan/" class="u-url">Go学习第二天-字符串相关</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/goxue-xi-di-er-tian-zi-fu-chuan-xiang-guan/" rel="bookmark">
            <time class="published dt-published" datetime="2021-09-08T21:06:45+08:00" itemprop="datePublished" title="2021-09-08 21:06">2021-09-08 21:06</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2 id="go-">Go学习第二天-字符串相关</h2>
<p>如果有不确定的地方, 可以在a tour of go上做做小实验</p>
<h3 id="byterune">byte和rune</h3>
<blockquote>
<p>Golang has integer types called byte and rune that are aliases for uint8 and int32 data types, repectively.</p>
</blockquote>
<p>所以byte和rune本质上就是uint8和uint32, byte用于ASCII编码, rune用于Unicode编码</p>
<p>除此之外, 在golang中, 没有char类型, 用于byte和rune表示char类型</p>
<p>值得注意, golang中的int和int32与int64并不是一个类型, <a href="https://golang.org/ref/spec#Numeric_types">int vs int32 vs 34</a>, 因此下面的代码并不合法</p>
<pre class="code literal-block"><span class="n">strconv</span><span class="o">.</span><span class="n">ParseInt</span><span class="p">(</span><span class="s2">"123"</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">//</span> <span class="n">ok</span>
<span class="k">var</span> <span class="n">a</span> <span class="nb nb-Type">int</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">strconv</span><span class="o">.</span><span class="n">ParseInt</span><span class="p">(</span><span class="s2">"123"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">//</span> <span class="n">error</span><span class="p">,</span> <span class="n">cannot</span> <span class="n">use</span> <span class="n">a</span> <span class="p">(</span><span class="n">type</span> <span class="n">int32</span><span class="p">)</span> <span class="k">as</span> <span class="n">type</span> <span class="nb nb-Type">int</span> <span class="ow">in</span> <span class="n">argument</span> <span class="n">to</span> <span class="n">strconv</span><span class="o">.</span><span class="n">ParseInt</span>
</pre>
<blockquote>
<p>In Go, Characters are expressed by enclosing them in single quotes like this: 'a'.</p>
</blockquote>
<p>在Go中, 用单引号来实现char的literal</p>
<p>默认情况下, char用rune来存储, 如下: </p>
<pre class="code literal-block"><span class="kd">var</span> <span class="nx">myLetter</span> <span class="p">=</span> <span class="sc">'a'</span> <span class="c1">// Type inferred as rune</span>
</pre>
<p>我们也可以显示声明一个byte存储的char, 如下: </p>
<pre class="code literal-block"><span class="kd">var</span> <span class="nx">myLetter</span> <span class="kt">byte</span> <span class="p">=</span> <span class="sc">'a'</span>
</pre>
<p>在上述表述中, char不是一个具体的类型</p>
<h3 id="_1">字符串</h3>
<p>在golang中, 字符串并不是byte数组或rune数组, 因为byte数组和rune数组都是可变，但字符串不可变(和除了C++以外的其他语言一样), </p>
<p>除此之外, 还有一个值得注意的是, byte数组和rune数组用fmt.Println()打印出来都是数字, 说明他们本质上仍然是uint8数组和uint32数组, 如果要打印出可读的字符串, 还是需要转成string</p>
<p>如下:</p>
<pre class="code literal-block"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
<span class="p">)</span> 

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="s">"张明阳是傻逼"</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="c1">// =&gt; 张</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">([]</span><span class="nb">rune</span><span class="p">(</span><span class="nx">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="c1">// =&gt; [24352 26126 38451]</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">([]</span><span class="nb">rune</span><span class="p">(</span><span class="nx">a</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="c1">// =&gt; 张明阳</span>
<span class="p">}</span>
</pre>
<h3 id="bytes-slice-over-string">bytes slice over string?</h3>
<p>由于string不可变, 因此在刷题时并不实用, 更实用的方法是通过bytes数组进行字符数据存储和操作, 只在需要显示时才将其转化为string</p>
<h3 id="strings">strings包</h3>
<p>string是go的内置类型, 而strings是针对string的包, 包含了处理string的诸多方法, 在此我们只列举部分常用函数</p>
<pre class="code literal-block">strings.Compare(s1, s2 string) int // 字符串比较
strings.Join([]string, string) // 拼接多个字符串
strings.Split(s, str string) // 切割字符串
strings.Fields(s strings) // 按空白字符切割字符串
strings.Repeat(s string, n int) string // 重复字符串
strings.Replace("张明阳是傻逼", "傻逼", "纯弱智", -1) // 替换字符串, -1表示替换所有, 如果大于0表示替换几个 // =&gt; 张明阳是纯弱智
strings.Contains(s, substr string) // 是否存在子串
strings.ContainsAny(s, chars string) // chars中的字符是否在s中出现过
strings.Index(s string, str string) // 返回str在s中第一次出现的位置, 如果不存在返回-1, str为空返回0
</pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/zhan-shi-fu-wu-qi-gpushi-yong-qing-kuang-ji-zhang-hao-ip/" class="u-url">展示服务器GPU使用情况及账号IP</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/zhan-shi-fu-wu-qi-gpushi-yong-qing-kuang-ji-zhang-hao-ip/" rel="bookmark">
            <time class="published dt-published" datetime="2021-09-03T20:45:38+08:00" itemprop="datePublished" title="2021-09-03 20:45">2021-09-03 20:45</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2 id="_1">问题分析：</h2>
<ol>
<li>首先通过crontab设置定时任务，将ip信息和gpu使用情况定时打到某文件中</li>
<li>通过one-shot-server创建服务</li>
<li>或者通过nginx创建服务</li>
</ol>
<h2 id="gpu">GPU使用情况脚本</h2>
<pre class="code literal-block"><span class="ch">#!/bin/bash</span>

<span class="nv">persons</span><span class="o">=()</span>
<span class="nv">usages</span><span class="o">=()</span>

<span class="k">for</span> t <span class="k">in</span> <span class="k">$(</span>nvidia-smi<span class="p">|</span>egrep <span class="s1">'^\|[\ ]{4}[[:digit:]]'</span> <span class="p">|</span> tr -d <span class="s1">'|'</span><span class="p">|</span>awk <span class="s1">'{print $4}'</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="c1"># command substitution</span>
    <span class="nv">persons</span><span class="o">+=(</span><span class="s2">"</span><span class="k">$(</span>cat /proc/<span class="nv">$t</span>/cgroup<span class="p">|</span>head -n <span class="m">1</span><span class="p">|</span>cut -d <span class="s1">'.'</span> -f <span class="m">3</span><span class="k">)</span><span class="s2">"</span><span class="o">)</span>
<span class="k">done</span>

<span class="k">for</span> t <span class="k">in</span> <span class="k">$(</span>nvidia-smi<span class="p">|</span>egrep <span class="s1">'^\|[\ ]{4}[[:digit:]]'</span> <span class="p">|</span> tr -d <span class="s1">'|'</span><span class="p">|</span>awk <span class="s1">'{print $7}'</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> 

    <span class="nv">usages</span><span class="o">+=(</span><span class="s2">"</span><span class="nv">$t</span><span class="s2">"</span><span class="o">)</span>
<span class="k">done</span>

<span class="nv">plen</span><span class="o">=</span><span class="si">${#</span><span class="nv">persons</span><span class="p">[@]</span><span class="si">}</span> <span class="c1"># parameter expansion</span>

<span class="nb">echo</span> <span class="s2">"------"</span>
<span class="nb">echo</span> <span class="s2">"usage:"</span>
<span class="nb">echo</span> <span class="s2">"------"</span>
<span class="nb">echo</span> 
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;<span class="si">${</span><span class="nv">plen</span><span class="si">}</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span> <span class="c1"># arithemetic expansion</span>
    <span class="nb">printf</span> <span class="s2">"%-10s\t | %10s\n"</span> <span class="si">${</span><span class="nv">persons</span><span class="p">[i]</span><span class="si">}</span> <span class="si">${</span><span class="nv">usages</span><span class="p">[i]</span><span class="si">}</span>
<span class="k">done</span>
<span class="nb">echo</span> 
<span class="nb">echo</span> <span class="s2">"update at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"------------------------------"</span>
<span class="nb">echo</span>
<span class="nb">echo</span> 
</pre>
<h2 id="ip">账号IP信息打印</h2>
<pre class="code literal-block">lxc list 
</pre>
<h2 id="crontab">crontab设置定时任务</h2>
<p>定时打印ip和gpu使用信息</p>
<pre class="code literal-block"><span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">status</span>
<span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">who_is_using_gpu</span><span class="o">.</span><span class="n">sh</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">usage</span>
<span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">who_is_using_gpu</span><span class="o">.</span><span class="n">sh</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">snap</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">lxc</span> <span class="n">list</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ip</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">ip</span><span class="o">.</span><span class="n">txt</span>
</pre>
<h2 id="one-shot-server">one-shot-server脚本</h2>
<pre class="code literal-block"><span class="c1">#/bin/bash</span>

<span class="nv">PORT</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">FILE</span><span class="o">=</span><span class="nv">$2</span>

<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">"</span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2">"</span> <span class="o">]]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">"The file </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2"> does not exist"</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"The file </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2"> does exist"</span>
<span class="k">while</span> <span class="o">[[</span> <span class="m">1</span> <span class="o">]]</span>
<span class="k">do</span>
  <span class="o">{</span> <span class="nb">echo</span> -ne <span class="s2">"HTTP/1.0 200 OK\r\nContent-Length: </span><span class="k">$(</span>wc -c &lt;<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="k">)</span><span class="s2">\r\n\r\n"</span><span class="p">;</span> cat <span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="p">;</span> <span class="o">}</span> <span class="p">|</span> nc -l -p <span class="si">${</span><span class="nv">PORT</span><span class="si">}</span>
<span class="k">done</span>
</pre>
<h2 id="one-shot-server_1">通过one-shot-server启动服务</h2>
<blockquote>
<p>最好启动两次, 我也不知道为什么</p>
</blockquote>
<pre class="code literal-block">nohup bash ./one_shot_server <span class="m">1205</span> /root/share/ip &gt; /dev/null <span class="p">&amp;</span> 
</pre>
<h2 id="nginx">通过nginx创建服务</h2>
<p>/etc/nginx/sites-enabled/default内容如下：</p>
<pre class="code literal-block"><span class="n">server</span> <span class="p">{</span>
       <span class="n">listen</span> <span class="mi">1205</span><span class="p">;</span>
       <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
            <span class="n">root</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
            <span class="n">index</span> <span class="n">ip</span><span class="o">.</span><span class="n">txt</span><span class="p">;</span>
       <span class="p">}</span>

<span class="p">}</span>
</pre>
<p>然后加载nginx配置</p>
<pre class="code literal-block">nginx -s reload
</pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/zi-dong-shang-chuan-shi-yan-shi-fu-wu-qi-xin-xi-dao-teng-xun-yun-fu-wu-qi/" class="u-url">自动上传实验室服务器信息到腾讯云服务器</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/zi-dong-shang-chuan-shi-yan-shi-fu-wu-qi-xin-xi-dao-teng-xun-yun-fu-wu-qi/" rel="bookmark">
            <time class="published dt-published" datetime="2021-09-03T19:31:01+08:00" itemprop="datePublished" title="2021-09-03 19:31">2021-09-03 19:31</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p>因为实验室服务器每次重启IP都可能改变，因此需要服务器重启后自动将IP上传到腾讯云服务器上，这样就不用每次连显示器去查询IP（十分麻烦）</p>
<h2 id="_1">问题分析</h2>
<ol>
<li>服务器无法自动连接到Internet，就无法连接到腾讯云，所以需要一个服务监听Internet连接状态，在没有Internet连接时，自动登陆校园网</li>
<li>为了方便，我们选择用ssh协议上传ip信息，并且60秒更新一次</li>
</ol>
<p>记录流程如下：</p>
<h2 id="ipetchosts">先将腾讯云IP加到/etc/hosts</h2>
<pre class="code literal-block"><span class="nb">echo</span> <span class="s2">"120.53.125.30     tencent_cloud"</span> &gt;&gt; /etc/hosts
</pre>
<h2 id="ssh-key-pubkeytencent_cloud">将ssh-key pubkey加到tencent_cloud的信任列表中</h2>
<p>以一步是防止ssh上传ip时要求输入密码</p>
<pre class="code literal-block">cat ~/.ssh/id_rsa.pub <span class="p">|</span> ssh ubuntu@tencent_cloud <span class="s1">'cat &gt;&gt; ~/.ssh/authorized_keys'</span> 
</pre>
<h2 id="internet">检测Internet连接并自动登陆校园网的脚本</h2>
<p>/usr/local/bin/autologin内容如下</p>
<pre class="code literal-block"><span class="ch">#!/bin/bash</span>

<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> ping -q -c <span class="m">1</span> -W <span class="m">1</span> <span class="m">8</span>.8.8.8 &gt;/dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Internet Connection is alive"</span>
    sleep <span class="m">10</span>
    <span class="k">else</span>
    python3 /home/dell/get2internet.py <span class="m">2020110966</span> Daxiahyh1
    <span class="k">fi</span>
<span class="k">done</span>
</pre>
<h2 id="ip">上传ip的脚本</h2>
<p>/usr/local/bin/upload-ip内容如下:</p>
<pre class="code literal-block"><span class="ch">#!/bin/bash</span>

<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
    <span class="nv">ipaddr</span><span class="o">=</span><span class="k">$(</span>ifconfig br0 <span class="p">|</span>egrep <span class="s1">'inet\ '</span><span class="p">|</span>awk <span class="s1">'{print $2}'</span><span class="k">)</span>
    <span class="nv">time</span><span class="o">=</span><span class="k">$(</span>date<span class="k">)</span>
    cat <span class="s">&lt;&lt;EOF | ssh root@tencent_cloud 'cat &gt; /var/www/html/lab_host3.html'</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt;</span>
<span class="s">&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">&lt;h1&gt;基础信息&lt;/h1&gt;</span>
<span class="s">&lt;p&gt;</span>
<span class="s">服务器编号： 3</span>
<span class="s">&lt;/p&gt;</span>
<span class="s">&lt;p&gt;</span>
<span class="s">服务器IP：$ipaddr</span>
<span class="s">&lt;/p&gt;</span>
<span class="s">&lt;p&gt;</span>
<span class="s">账号IP及GPU使用情况: &lt;a href="http://$ipaddr:1205"&gt;入口&lt;/a&gt;</span>
<span class="s">&lt;/p&gt;</span>
<span class="s">&lt;p&gt;update time: $time&lt;/p&gt;</span>
<span class="s">&lt;h1&gt;README&lt;/h1&gt;</span>
<span class="s">&lt;h2&gt;硬件信息&lt;/h2&gt;</span>
<span class="s">&lt;p&gt;</span>
<span class="s">GPU: 两块3080(公用) &lt;br /&gt;</span>
<span class="s">CPU: Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz &lt;br /&gt;</span>
<span class="s">&lt;/p&gt;</span>
<span class="s">&lt;h2&gt;使用注意&lt;/h2&gt;</span>
<span class="s">&lt;p&gt;</span>
<span class="s">&lt;ul&gt;</span>
<span class="s">&lt;li&gt;</span>
<span class="s">服务器IP在重启后IP可能变化, 但这个链接不会变化, 要是发现服务器登不上, 可以点击上面的账号IP信息入口, 查看自己账号IP是否改变过</span>
<span class="s">&lt;/li&gt;</span>
<span class="s">&lt;li&gt;</span>
<span class="s">/share下是公用目录, 建议将数据集放在这(这样别人也可以用), 以及和别人共享文件, 也是这个目录, 显卡驱动安装脚本(rescue.sh)也在这里, 最好不要自己瞎装驱动了, 如果要自己装, 后面加上--no-kernel-module参数</span>
<span class="s">&lt;/li&gt;</span>
<span class="s">&lt;li&gt;</span>
<span class="s">账号默认root密码是1205, ssh端口是42502, 最好改一下密码</span>
<span class="s">&lt;/li&gt;</span>
<span class="s">&lt;li&gt;</span>
<span class="s">如果要对自己的容器进行一些奇奇怪怪的操作之前, 可以提前让我给你容器创建个备份, 不然可能发生一些不太好的事情</span>
<span class="s">&lt;/li&gt;</span>
<span class="s">&lt;/ul&gt;</span>
<span class="s">&lt;/p&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">&lt;/html&gt;</span>
<span class="s">EOF</span>
    sleep <span class="m">60</span>
<span class="k">done</span>
</pre>
<h2 id="autologinservice">创建autologin.service文件</h2>
<p>/etc/systemd/system/autologin.service内容如下：</p>
<pre class="code literal-block"><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Auto Login for Internet</span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/autologin</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre>
<h2 id="upload-ipservice">创建upload-ip.service文件</h2>
<p>/etc/systemd/system/upload-ip.service内容如下：</p>
<pre class="code literal-block"><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Send ip to remote tencent cloud server</span>
<span class="na">After</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/upload-ip</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre>
<h2 id="_2">启动服务</h2>
<pre class="code literal-block">sudo systemctl deamon-reload
sudo systemctl start upload-ip.service
sudo systemctl <span class="nb">enable</span> upload-ip.service
sudo systemctl start autologin.service
sudo systemctl <span class="nb">enable</span> autologin.service
</pre>
<h2 id="systemctl-cheatsheet">附送systemctl cheatsheet</h2>
<pre class="code literal-block"><span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span> <span class="c1"># Reload the service files to include the new service</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">your</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">service</span> <span class="c1"># Start your service</span>
<span class="n">systemctl</span> <span class="n">status</span> <span class="n">your</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">service</span> <span class="c1"># To check the status of your service</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">your</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">service</span> <span class="c1"># To enable your service on every reboot</span>
<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">your</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">service</span> <span class="c1"># To disable your service on every reboot</span>
</pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/e-yi-dai-ma-fen-xi-ji-chu-di-yi-tian/" class="u-url">恶意代码分析基础-第一天</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/e-yi-dai-ma-fen-xi-ji-chu-di-yi-tian/" rel="bookmark">
            <time class="published dt-published" datetime="2021-08-26T21:01:29+08:00" itemprop="datePublished" title="2021-08-26 21:01">2021-08-26 21:01</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2 id="-">恶意代码分析基础-第一天</h2>
<p>PE分析工具：PEID, ExecInfo</p>
<p><a href="https://thunderjie.github.io/2019/03/27/PE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3/">PE结构详解 | Thunder_J (thunderjie.github.io)</a> </p>
<p><a href="https://www.cnblogs.com/night-ride-depart/p/5776107.html">PE结构分析 | 输入表结构和输入地址表(IAT)</a></p>
<blockquote>
<p>HNT和IAT内容相同, 但HNT被载入内存后不再改变, IAT会被覆写从而直接指向API函数地址</p>
</blockquote>
<p><a href="https://blog.csdn.net/Cody_Ren/article/details/77815952">IAT导入函数地址表</a> </p>
<blockquote>
<p>用实例讲解, 有IAT解析流程</p>
</blockquote>
<p>脱壳需要做的两件事: 修复IAT表, 覆写OEP, dump</p>
<p><strong>为什么要有IAT修复?</strong></p>
<blockquote>
<p>程序在脱壳完成进入OEP的时候, IAT已经被覆写了,
为了让dump出的程序正常运行, 我们需要将IAT进行修复
从INT重建IAT不靠谱是因为在脱壳过程中, 完全可以毁掉INT, 而原始加壳文件payload被加密, 无法确定INT的位址和内容</p>
</blockquote>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/" class="u-url">论文阅读-类别增量学习-Class-incremental learning: survey and performance evaluation on image classification</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/" rel="bookmark">
            <time class="published dt-published" datetime="2021-08-21T13:28:23+08:00" itemprop="datePublished" title="2021-08-21 13:28">2021-08-21 13:28</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<div class="toc">
<ul>
<li><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#_1">前言</a></li>
<li><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#_2">简介</a></li>
<li>
<a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#_3">一些常见概念</a><ul>
<li><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#task-il-vs-class-il">task-IL vs class-IL</a></li>
<li><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#sil-vs-cil-vs-fil">SIL vs CIL vs FIL</a></li>
</ul>
</li>
<li><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#_4">问题</a></li>
<li><a href="posts/lun-wen-yue-du-lei-bie-zeng-liang-xue-xi-class-incremental-learning-survey-and-performance-evaluation-on-image-classification/#_5">方法</a></li>
</ul>
</div>
<h3 id="_1">前言</h3>
<blockquote>
<p>基于增量学习的恶意代码家族分类
为什么用增量学习 + 恶意代码家族分类?
恶意代码家族分类是需要增量学习的典型任务场景, 恶意代码家族不可能预先给定, 不同的恶意代码家族会随着发展不断产生变体, 而在所有数据集上重新训练模型也是难以实现的, 是典型的class-incremental learning场景
其次, BODMAS数据集中包含500多个恶意代码家族, 为研究增量学习提供了可能性
再其次, 增量学习目前发展较慢, 仍存在大量问题, 通过增量学习实现恶意代码家族分类是有意义的, 而针对恶意代码家族分类去研究增量学习也是有意义的</p>
</blockquote>
<h3 id="_2">简介</h3>
<p>In most incremental learning scenarios, tasks are presented to a learner in a sequence of delineated <em>training sessions</em> during which data from a single task is available for learning.
After each training session, the learner should be capable of performing all perviously seen tasks on unseen data.</p>
<blockquote>
<p>在增量学习场景下, 每一轮训练针对一个任务进行训练, 在训练结束后, 要求模型能对前面训练过的所有任务进行完成</p>
</blockquote>
<p>The main challenge in incremental learning is to learn from data from the current task in a way that prevents forgetting of previously learned tasks.</p>
<blockquote>
<p>增量学习的主要问题就是避免当前训练对以前任务的遗忘</p>
</blockquote>
<p>这一点和迁移学习类似但也有所不同, 迁移学习不要求对以前训练任务的知识实现保留</p>
<p>They aim to exploit knowledge from previous classes to improve learning of new ones(<em>forward transfer</em>), as well as exploiting new data to improve performance on previous tasks(<em>backward transfer</em>)</p>
<blockquote>
<p>用旧知识帮助学习新知识, 用新知识巩固旧知识, sounds make sense</p>
</blockquote>
<h3 id="_3">一些常见概念</h3>
<h4 id="task-il-vs-class-il">task-IL vs class-IL</h4>
<p>task-IL: task-incremental learning, 在inference的时候, 会给定样本的task ID</p>
<p>class-IL: class-incremental learning, 在inference的时候, 不给定样本的task ID</p>
<p>这里还是有些不清楚</p>
<h4 id="sil-vs-cil-vs-fil">SIL vs CIL vs FIL</h4>
<ol>
<li>SIL</li>
</ol>
<p>问题：由于新数据的各种原因，样本的特征值可能会改变，每个类别的比例也会改变。这些都会影响分类的准确率。</p>
<p>任务：因此，需要确保在现有知识的情况下，通过新样本的增量学习来提取新知识，融合新旧知识以提高分类的准确性。</p>
<ol>
<li>
<p>CIL
任务：识别新类，并将其加入现有类别的集合中，提升分类的准确性和智能。</p>
</li>
<li>
<p>FIL
一些新的属性特征能够将分类提升到一个很大的程度，并提升分类准确率。</p>
</li>
</ol>
<p>任务：在现有特征空间的基础上，加入新的属性特征，构建新的特征空间，提升分类准确率。</p>
<h3 id="_4">问题</h3>
<p>catastrophic forgetting(灾难性遗忘), 为了克服灾难性遗忘, 我们一方面希望模型能从新数据中有效学习新知识, 但另一方面又必须防止新输入的数据对已有知识的显著干扰(稳定性), 即<strong>稳定性-可塑性困境</strong>(stability-plasticity dilemma)</p>
<p>增量学习的主要研究目的就是在计算和存储资源有限的条件下, 在稳定性-可塑性困境中寻找最佳平衡点</p>
<h3 id="_5">方法</h3>
<ol>
<li>
<p>正则(regularization)</p>
</li>
<li>
<p>回放(rehearsal)</p>
</li>
<li>
<p>参数隔离(parameter isolation)</p>
</li>
</ol>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/goxue-xi-di-yi-tian-gotooling/" class="u-url">Go学习第一天 - GoTooling</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/goxue-xi-di-yi-tian-gotooling/" rel="bookmark">
            <time class="published dt-published" datetime="2021-08-20T22:38:06+08:00" itemprop="datePublished" title="2021-08-20 22:38">2021-08-20 22:38</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2 id="go-gogotooling">Go学习第一天, 从GO安装到GoTooling使用</h2>
<h3 id="gopath-vs-goroot">GOPATH vs GOROOT</h3>
<blockquote>
<p>The GOPATH environment variable lists places to look for Go code. On Unix, the value is a colon-separated string, On Windows, the value is a semicolon-separated string, On Plan9, the value is a list
GOPATH must be set to get, build and install packages outside the standard Go Tree(即GO SDK)</p>
<p>GOROOT is where the go SDK being installed</p>
</blockquote>
<p>GOPATH就是Go安装第三方库的位置, 通过改变这个，我们可以自由切换依赖环境, 实现类似于python中virtualenv的功能</p>
<p>GOROOT就是Go SDK的安装位置</p>
<h3 id="go-sdk">安装GO SDK</h3>
<ol>
<li>下载安装包</li>
<li>如下</li>
</ol>
<pre class="code literal-block">rm -rf /usr/local/go <span class="o">&amp;&amp;</span> tar -C /usr/local -xzf go1.14.3.linux-amd64.tar.gz
<span class="nb">echo</span> <span class="s2">"export PATH=</span><span class="nv">$PATH</span><span class="s2">:/usr/local/go/bin"</span> &gt;&gt; ~/.bashrc 
go version <span class="c1"># check if installed </span>
</pre>
<h3 id="_1">配置代理</h3>
<pre class="code literal-block">go env -w <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,direct
</pre>
<h3 id="go">创建第一个GO可执行程序</h3>
<p>在go1.2以前, 如果要创建一个命名类似于"github.com/foo"的包的话, 需要在"$GOPATH/src/github.com"下创建, 流程如下:</p>
<pre class="code literal-block">mkdir -p <span class="nv">$GOPATH</span>/src/github.com/foo
</pre>
<p>在编译go项目后, 可以通过go install进行安装, 会将项目安装在"$GOPATH/bin/"下:</p>
<pre class="code literal-block"><span class="k">go</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">hello</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nc">binary</span><span class="w"></span>
<span class="err">$</span><span class="n">GOPATH</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">hello</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">it</span><span class="w"></span>
</pre>
<p>如果将GOPATH加入到了PATH中, 可以直接运行</p>
<pre class="code literal-block">hello
</pre>
<h3 id="go-module">创建第一个GO module</h3>
<p>大致流程和创建GO程序差不多, 但和GO程序的区别在于GO包编译并不会生成可执行文件, 因此我们并不需要使用"go install"命令进行安装, 
在完成后, 使用"go build"测试一下包能够通过编译即可</p>
<pre class="code literal-block">mkdir <span class="nv">$GOPATH</span>/src/github.com/foo/stringutil
go build github.com/goo/stringutil
</pre>
<h3 id="go-module_1">更好的go module创建方式</h3>
<p>在go1.2后, 通过go.mod, 我们不再需要在$GOPATH/src/下进行项目开发了, 相应的, 我们可以通过定义go.mod来创建module</p>
<p>首先执行go init生成用于管理的go.mod和go.sum文件</p>
<pre class="code literal-block">go mod init github.com/foo 
</pre>
<p>一个典型的go.mod如下, </p>
<pre class="code literal-block"><span class="k">module</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">dagrons</span><span class="o">/</span><span class="n">godw</span><span class="w"></span>

<span class="k">go</span><span class="w"> </span><span class="mf">1.16</span><span class="w"></span>

<span class="n">require</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">gin</span><span class="o">-</span><span class="n">gonic</span><span class="o">/</span><span class="n">gin</span><span class="w"> </span><span class="n">v1</span><span class="mf">.7.2</span><span class="w"></span>
</pre>
<p>指定了module名, go SDK版本, 以及依赖的第三方库及版本, </p>
<p>这种项目依赖管理方式和package.json和Gemfile类似, 更加好用</p>
<p>在go.mod编写完成后, 需要通过"go tidy mod"进行依赖解析, 会下载并解析好所有的依赖关系</p>
<pre class="code literal-block">go mod tidy
</pre>
<h3 id="go-tooling">其他常见的GO Tooling命令</h3>
<p>GO环境变量</p>
<pre class="code literal-block">go env <span class="c1"># list all go envs</span>
<span class="nb">export</span> <span class="nv">GOPATH</span><span class="o">=</span>&lt;XXXX&gt; <span class="c1"># go env 会读取环境变量, 因此我们在环境变量中设置相应的变量即可, 上一种方法可能会失效</span>
<span class="nb">export</span> <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,direct
</pre>
<p>执行GO程序</p>
<pre class="code literal-block">go run ./acwing/qsort 
go run github.com/dagrons/god/acwing/qsort <span class="c1"># the two are equivalent</span>
</pre>
<p>依赖解析</p>
<pre class="code literal-block">go get -u golang.org/x/tools/... <span class="c1"># 获取某个依赖</span>
go mod tidy <span class="c1"># 项目整体依赖解析</span>
go mod edit -replace<span class="o">=</span>github.com/axe/argonid<span class="o">=</span>/home/axe/argonid <span class="c1"># create the replace rule # 会将远程依赖代理到本地依赖</span>
go mod edit -dropreplace<span class="o">=</span>github.com/axe/argonid <span class="c1"># 取消代理规则</span>
go list -m all <span class="c1"># list all dependencies</span>
go clean -modcache <span class="c1"># clean module cache</span>
</pre>
<p>测试</p>
<pre class="code literal-block">go <span class="nb">test</span> all <span class="c1"># test all dependencies including SDK libraries</span>
go <span class="nb">test</span> ./acwing/qsort <span class="c1"># test a single file</span>
go <span class="nb">test</span> ./... <span class="c1"># test all # ./...表示所有文件</span>
go <span class="nb">test</span> -cover ./... <span class="c1"># cover展示测试覆盖情况, 因为有的函数不一定有测试</span>
</pre>
<p>文档</p>
<pre class="code literal-block">go doc leetcode/l51 <span class="c1"># 展示文档部分</span>
go doc -all leetcode/l52 <span class="c1"># 优化显示</span>
go doc -all leetcode/l52.SolveNQueens <span class="c1"># 函数文档</span>
go doc -src leetcode/l52.SolveNQueens <span class="c1"># 显示源码</span>
</pre>
<p>构建与部署</p>
<pre class="code literal-block">go build -o<span class="o">=</span>/tmp/foo <span class="c1"># compile current package into /tmp/foo</span>
go build -o<span class="o">=</span>/tmp/foo ./cmd/foo <span class="c1"># compile ./cmd/foo into /tmp/foo</span>
go build -a -o<span class="o">=</span>/tmp/foo . <span class="c1"># force all packages to be rebuilt</span>
go clean -cache <span class="c1"># clear build cache </span>
<span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -o<span class="o">=</span>/tmp/linux_amd64/foo . <span class="c1"># cross-platform compilation specified with GOOS and GOARCH</span>
<span class="nv">GOOS</span><span class="o">=</span>windows <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -o<span class="o">=</span>/tmp/windows_amd64/foo.exe 
</pre>
<h3 id="vscode">必备VSCode插件</h3>
<ol>
<li>Go # All in One</li>
<li>code runner # single file execution</li>
<li>git &amp;&amp; git history</li>
</ol>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/pythonduo-xian-cheng-xue-xi/" class="u-url">Python学习-多线程神器concurrent.futures</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/pythonduo-xian-cheng-xue-xi/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-13T21:43:08+08:00" itemprop="datePublished" title="2021-04-13 21:43">2021-04-13 21:43</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<blockquote>
<p>理解python docs，首先是Executor Objects, Thread/ProcessPoolExecutor, 然后是Module Functions, 最后是Exception classes，不止是学习API，还要了解它的思维框架</p>
</blockquote>
<h3 id="intro">Intro</h3>
<p>The concurrent.futures module provides a high-level interface for asynchronously executing callables</p>
<p>keyword: callables, high-level</p>
<h3 id="_1">基本框架</h3>
<pre class="code literal-block"><span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">future_to_url</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%r</span><span class="s1"> generated an exception: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%r</span><span class="s1"> page is </span><span class="si">%d</span><span class="s1"> bytes'</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
</pre>
<h3 id="_2">提交任务</h3>
<pre class="code literal-block"><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="c1"># 创建并提交一个任务</span>
<span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">)</span> <span class="c1"># 对iterables中每个值都创建并提交一个任务</span>
<span class="n">等价于</span><span class="p">:</span>
<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">iterables</span><span class="p">:</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre>
<h3 id="_3">查询任务本身状态？</h3>
<pre class="code literal-block"><span class="n">future</span><span class="o">.</span><span class="p">[</span><span class="n">cancel</span><span class="p">(),</span> <span class="n">cancelled</span><span class="p">(),</span> <span class="n">running</span><span class="p">(),</span> <span class="n">done</span><span class="p">(),</span> <span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">exception</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)]</span>
</pre>
<h3 id="_4">下班</h3>
<pre class="code literal-block"><span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 下班了!</span>
<span class="n">wait</span><span class="o">=</span><span class="n">True会等待所有工作做完</span><span class="err">，</span><span class="n">才下班</span>
</pre>
<h3 id="_5">有趣的方法！</h3>
<pre class="code literal-block"><span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="n">fn的唯一参数为future</span>
</pre>
<blockquote>
<p>怀念js，怀念functional</p>
</blockquote>
<h3 id="executor-objects">Executor Objects</h3>
<p>abstract class: concurrent.futures.Executor(need to be implemented!)
继承关系：</p>
<blockquote>
<p>继承包含实现继承和接口继承</p>
</blockquote>
<pre class="code literal-block"><span class="n">Executor</span><span class="o">[</span><span class="n">abstract</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Threadpoolexecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">[</span><span class="n">concrete</span><span class="o">]</span><span class="w"></span>
<span class="w">           </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Processpoolexecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">[</span><span class="n">concrete</span><span class="o">]</span><span class="w"></span>
</pre>
<h3 id="threadpool-or-processpool">ThreadPool or ProcessPool?</h3>
<p>CPU bottleneck? =&gt; ProcessPool（亲测，如果是CPU bottleneck，要比ThreadPool快很多）</p>
<p>I/O bottleneck? =&gt; ThreadPool（如果bottleneck不在CPU上，就没必要用ProcessPool了，ThreadPool开销更小）</p>
<h3 id="module-functions">Module Functions</h3>
<ol>
<li>等待所有任务完成？（注意：这会阻塞当前线程）</li>
</ol>
<pre class="code literal-block"><span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
<span class="sd">"""</span>
<span class="sd">return_when =&gt; </span>
<span class="sd">FIRST_COMPLETED: any future finishes or is cancelled</span>
<span class="sd">FIRST_EXCEPTION: any future finishes by raising an exception or all completed</span>
<span class="sd">ALL_COMPLETED: when all future finishes or cancelled</span>
<span class="sd">"""</span>
</pre>
<ol>
<li>获取所有已经完成的任务（或者已经被取消的任务）</li>
</ol>
<pre class="code literal-block"><span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre>
<h3 id="exception-classes">Exception Classes</h3>
<blockquote>
<p>异常是程序无法语料之事，已经无法继续运行，当异常出现时，可以通过两种方式修补，一是提前预防(pre-process)，一种是通过适当的逻辑进行修补，提前判断和过滤，第二种是亡羊补牢(post-process)，在异常发生后，通过try...except进行捕获与处理.</p>
</blockquote>
<pre class="code literal-block"><span class="mf">1.</span> <span class="n">CancelledError</span><span class="p">:</span> <span class="n">Raised</span> <span class="n">when</span> <span class="n">a</span> <span class="n">future</span> <span class="n">is</span> <span class="n">cancelled</span>
<span class="mf">2.</span> <span class="n">TimeoutError</span><span class="p">:</span> <span class="n">Raised</span> <span class="n">when</span> <span class="n">a</span> <span class="n">future</span> <span class="n">operation</span> <span class="n">exceeds</span> <span class="n">the</span> <span class="n">given</span> <span class="n">timeout</span>
<span class="mf">3.</span> <span class="n">BrokenError</span><span class="p">:</span> <span class="n">Derived</span> <span class="n">from</span> <span class="kr">Run</span><span class="n">timeError</span><span class="p">,</span> <span class="n">raised</span> <span class="n">when</span> <span class="n">a</span> <span class="n">executor</span> <span class="n">is</span> <span class="n">broken</span> <span class="kr">for</span> <span class="n">some</span> <span class="n">reason</span>
<span class="mf">4.</span> <span class="n">InvalidStateError</span><span class="p">:</span> <span class="n">an</span> <span class="n">operation</span> <span class="n">is</span> <span class="n">performed</span> <span class="kr">on</span> <span class="n">future</span> <span class="n">that</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="n">in</span> <span class="n">the</span> <span class="n">curren</span> <span class="n">state</span>
<span class="mf">5.</span> <span class="n">BrokenThreadPool</span><span class="p">:</span> <span class="n">when</span> <span class="kr">on</span><span class="n">e</span> <span class="n">of</span> <span class="n">the</span> <span class="n">workers</span> <span class="n">of</span> <span class="n">a</span> <span class="n">ThreadPoolexecutor</span> <span class="n">has</span> <span class="n">failed</span> <span class="n">initializing</span>
<span class="mf">6.</span> <span class="n">BrokenProcessPool</span><span class="p">:</span> <span class="n">when</span> <span class="kr">on</span><span class="n">e</span> <span class="n">of</span> <span class="n">the</span> <span class="n">workers</span> <span class="n">of</span> <span class="n">Processpoolexecutor</span> <span class="n">has</span> <span class="n">failed</span> <span class="n">initializing</span>
</pre>
<h3 id="faq">FAQ</h3>
<ol>
<li>concurrent.futures vs multiprocessing, why concurrent.futures are preferred?</li>
</ol>
<p>concurrent.futures在threading和multiprocessing上做了封装，以灵活性为代价提供了更简单的接口
(见)[https://stackoverflow.com/questions/20776189/concurrent-futures-vs-multiprocessing-in-python-3]</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/zwkxian-duan-shu-zhe-mo-ri-ji/" class="u-url">算法学习-zwk线段树</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/zwkxian-duan-shu-zhe-mo-ri-ji/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-11T14:42:47+08:00" itemprop="datePublished" title="2021-04-11 14:42">2021-04-11 14:42</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><strong>前言：我为什么要学线段树</strong></p>
<blockquote>
<p>老实讲，学线段树只是最近看到了zwk大佬的动态，然后去搜了一下这个人，发现他有个zwk线段树，于是觉得很感兴趣，就下载了他的课件去探究，发现真的和大佬的世界差距太多了，深深感受到智商的碾压！</p>
</blockquote>
<p><strong>一些基础知识</strong></p>
<ol>
<li>常见的树结构存储方式：堆式存储（建立存储位置和逻辑位置的关系/多用于满二叉树或 可以满二叉树的情况），链式存储（这个就不说了）</li>
<li>树结构的根节点存储位置常从1开始，用0表示非法值</li>
<li>对于堆结构的树，s和s^1互为兄弟节点，可以用s^t^1判断两个节点是否是兄弟节点</li>
<li>一个节点的左儿子是s&gt;&gt;1，右节点是s&gt;&gt;1|1</li>
<li>左儿子存储位置为偶数，右儿子存储位置为奇数，因此~s^1可以判断是左节点，s^1判断右节点</li>
</ol>
<p><strong>线段树？</strong></p>
<p>解决区间查询，区间修改问题</p>
<p><strong>思想？</strong></p>
<p>二分，将区间信息组织成树状形式，父节点维护的信息就是子节点的合并</p>
<p><strong>那？zwk线段树？</strong></p>
<p>传统线段树常数较大，实现复杂，而且是Top-down Approach，zwk使用Bottom-up的方式，利用堆式结构进行存储，常数更小</p>
<p><strong>How?</strong></p>
<pre class="code literal-block"><span class="c1">// .data</span>
<span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">N</span><span class="p">];</span><span class="w"> </span><span class="c1">// 根节点为1</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="c1">// M为维护的区间大小</span>

<span class="c1">// build</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">build</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// query：查询[s, t]</span>
<span class="c1">// 只能查询[1, 2^n-2]的区间</span>
<span class="c1">// s和s^1互为兄弟节点</span>
<span class="c1">// s^t^1判断s和t是否是兄弟节点，s^t^1 == 0 &lt;=&gt; s^1 == t，注意，异或具有交换律</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="n">M</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">^</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ans</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// modify: 单点修改</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">+=</span><span class="n">m</span><span class="p">]</span><span class="o">=</span><span class="n">val</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>
<p><strong>完了吗？</strong></p>
<p>没有，还有区间修改呢！</p>
<p><strong>How？</strong></p>
<p>懒标记！不知道？先去看https://oi-wiki.org/ds/seg/吧</p>
<p>懒标记成功地减少了pushdown的次数，只在需要的时候才pushdown，复杂度为O(logn)</p>
<p><strong>等等，我们不是Bottom-up吗？</strong></p>
<p>是的，但我们依然可以使用懒标记和Top-down来更新懒标记啊！</p>
<p><strong>但是！我们有更好的方法</strong></p>
<p>Bottom-up就要Bottom-up到底！</p>
<p>其实区间修改和区间查询的过程是差不多的，都是对区间相应节点的遍历</p>
<p>我们考虑标记，标记是什么，标记是父节点对子节点的相对值！</p>
<p><strong>等等，有了相对值，我们还需要绝对值干嘛</strong></p>
<p>如果我们让所有节点的值从0开始，那不就不需要绝对值了嘛，那我们在每个节点还存绝对值干嘛，只存一个标记就行了嘛！</p>
<p>嗯，标记是父节点对子节点的相对值，这对Top-down的过程很好，那对Bottom-up呢？</p>
<p>那我们就存子节点对父节点的相对值？</p>
<p><strong>好了， 我们来捋一捋</strong></p>
<p>假设我们有三个节点：f, l, r，其中f为父节点，l和r为子节点，假设他们的标签值为x, y, z，即l的最大值比f大y，r的最大值比f大z，f比他父亲大x</p>
<p>那我们如何知道f的最大值究竟是多少呢，应该是(T[f] + T[f&gt;&gt;1] + ... T[1]) + 所有子节点区间相对于f的最大值，对于前者，我们只需要向上遍历即可求出，那对于后者？我们不可能去遍历所有的可能路径吧。。。。</p>
<p><strong>除非？？？我们在每一次向上修改时，都保证每个节点存储的是子树区间的相对最大值？</strong></p>
<p><strong>什么意思？</strong></p>
<pre class="code literal-block"><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">;</span><span class="w"></span>
</pre>
<p>在向上修改的过程中，通过上述操作，我们保证了每一个节点的值都是所有构成子区间的相对最大值！更细的也不好解释了，建议多画画图去体会。。。</p>
<p><strong>好了，我们来看一下完整的代码</strong></p>
<pre class="code literal-block"><span class="c1">// 区间修改</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">A</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="n">M</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">^</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// 区间查询</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">rans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">M</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">^</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">rans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">lans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">lans</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">rans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">rans</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">lans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">rans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">lans</span><span class="p">,</span><span class="w"> </span><span class="n">rans</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ans</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>
<p><strong>OK, 完了？</strong>*</p>
<p>完了...</p>
<p><strong>参考</strong></p>
<p>zwk-《the power of statistics》</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/yi-xie-jing-yan/" class="u-url">一些废话</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/yi-xie-jing-yan/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-01T14:11:48+08:00" itemprop="datePublished" title="2021-04-01 14:11">2021-04-01 14:11</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2 id="misc">misc</h2>
<ol>
<li>用git管理项目，追溯代码的变化，一方面可以回溯，一方面可以检查bug是如何产生的 </li>
<li>层次感，结构感，流程清晰，注释详尽</li>
</ol>
<h2 id="s">S端</h2>
<ol>
<li>后端开发对于简单事务的路由封装很容易，但涉及到并发，同步，IPC，任务队列，负载均衡，数据库同步，横向扩展就会变得十分麻烦</li>
<li>尽量把数据库，虚拟机，docker放在服务器，不然把本地很快就会变得十分卡顿，尤其是涉及到文件读写和HTTP请求时</li>
</ol>
<h2 id="c">C端</h2>
<ol>
<li>对于SPA而，，多用development server + proxy代理进行测，，没必要部署到server，费时费力，而且修改麻烦</li>
<li>前端的模型是一棵树，不同的组件挂载到不同的节点，重点是处理路由，组件通信，以及节点本身的状态机模型</li>
<li>对于js，应该尽量避免this和class</li>
<li>前端和后端有个非常不同的点，就是前端开发应用层的代码逻辑很容易就变得极其复杂，而后端的复杂逻辑主要集中在和业务正交的领域</li>
</ol>
<h2 id="_1">对抗复杂性的方法</h2>
<ol>
<li>封装，对外只暴漏接口和方法</li>
<li>多态，对于同一方法，根据类型不同而使用不同的实现</li>
<li>继承，包括实现继承和接口继承，两者的目的是不一样的，实现继承是为了代码复用，接口继承并没有复用代码，而是需要自己实现相应的接口函数，接口继承的目的是为了实现抽象，继承响应的接口并实现它们以实现对其他组件的拔插，注意，在支持duck type的语言中，没有显式的接口声明</li>
</ol>
<pre class="code literal-block">&gt;在C++中，使用abstract class对应接口继承，使用class对应实现继承，有的abstract class既有接口继承也有实现继承，其中virtual function对应接口继承，在ruby，python中，由于使用duck type，没有显式的接口声明，而ruby使用class和maxin对应实现继承，python使用class对应实现继承
&gt;python和C++都有多继承，要注意菱形继承的问题
</pre>
<ol>
<li>Convention over configuration，除非用户指定，否则使用默认的配置，让组件使用者只关心它关心的接口参数</li>
<li>使用树形结构或嵌套结构增强层次感和结构感，隐藏细节</li>
<li>框架就是对于某一类任务提供的各种封装好的工具库，接口以及实现</li>
</ol>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/jszhong-de-promiseji-zhi/" class="u-url">js学习-理解promise机制</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/jszhong-de-promiseji-zhi/" rel="bookmark">
            <time class="published dt-published" datetime="2021-03-23T11:18:42+08:00" itemprop="datePublished" title="2021-03-23 11:18">2021-03-23 11:18</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2 id="js-promise">Js中的核心机制-Promise</h2>
<p>“在异步中实现同步”</p>
<p>如果说js中有什么东西造就了他的与众不同，我想，既不是functional programming这种几十年前的老东西，也不是None和undefined这种奇怪的机制，甚至于this的dynamic scope都不足以支撑js成为一门与众不同而独占前端市场的语言，而是他的异步机制，js是专为异步编程设计的语言，不只是体现在语法上，更重要的是其提供的基建。</p>
<p>在前端开发中，相当大的一部分工作是在进行UI渲染和回调处理，这不仅是web独有的特点，而是针对几乎所有前端开发的共有特性，在前端逻辑中，我们经常关注于一个按钮被点击后会发生什么，当我们从服务器中获取数据后要干什么...，于是有了“事件流”的概念，我们将事件流想象成一个队列，主线程从事件流中不断取出事件，并进行处理。</p>
<p>这里涉及两个问题，1. 主线程如何根据事件确定相应的处理逻辑？2. 主线程如何确保处理逻辑不会阻塞</p>
<p>对于问题1，js中提供了相当多的机制，典型的例子就是DOM的事件监听机制，用户在各种事件上注册各种处理函数，从而确定事件对应的处理逻辑，还例如fetch的回调，用于执行fetch返回后的处理逻辑</p>
<p>对于问题2，主线程如何确保处理逻辑不会阻塞，首先，我们要时刻谨记“js是单线程的”，也就是说，所有的操作都在一个线程内完成，这似乎很难理解，但回到我们之前的事件流模型，就不难发现，整个程序所做的事件不过是：</p>
<pre class="code literal-block"><span class="k">while</span> <span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">pop_front</span><span class="p">();</span>
    <span class="nx">handle</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>虽然js是单线程的，但浏览器并非单线程，浏览器只是为每个window开一个js线程，一个UI渲染引擎。</p>
<p>既然js是单线程的语言，所以要求我们的事件处理函数一定是不能阻塞我们的主线程，其中UI渲染事件会被交给UI渲染引擎进行处理，而fetch和setTimeout,setInterval，以及DOM的各种OnXXX事件，如何保证它们被处理的时候不阻塞呢，答案是：异步/non-blocking</p>
<p>在js中，异步/non-blocking常与Promise挂钩</p>
<h3 id="promise">Promise</h3>
<p>在js中，异步/non-blocking的含义就是将一个同步的过程分解成几个步骤，使得原来阻塞的处理逻辑变得不阻塞，举个例子：我们想要从server端获取数据，然后进行处理，但从server端获取数据的过程是会产生阻塞的，于是js提出了promise机制，首先它让fetch变成non-blocking的调用，然后允许我们对fetch的返回数据注册处理函数，但是这个处理函数是在fetch的返回数据确定后执行</p>
<p>所以，什么是Promise机制呢：</p>
<h4 id="promise_1">Promise维护了操作的执行信息</h4>
<p>用mdn上的话说：</p>
<blockquote>
<p>A Promise is an object representing the eventual completion or failure of an asynchronous operation.</p>
</blockquote>
<p>也就是说Promise维护了异步操作执行情况的相关信息，pending, fullfilled, rejected</p>
<p>那除此之外呢？</p>
<h4 id="promiseaysn_ops">Promise提供了一套描述aysn_ops间执行关系的语言</h4>
<p>Promise提供了一套Chain规则，让我们方便地描述异步操作的执行过程</p>
<p>如下：</p>
<pre class="code literal-block"><span class="nx">asyn_operations</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">successCallback</span><span class="p">,</span> <span class="nx">failureCallback</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">successCallback</span><span class="p">,</span> <span class="nx">failureCallback</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
<span class="p">...</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">failureCallback</span><span class="p">)</span>

<span class="nx">注意</span><span class="err">：</span><span class="nx">其中</span>
<span class="mf">1.</span> <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)=&gt;{},</span> <span class="kc">null</span><span class="p">)</span><span class="nx">简记为</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)=&gt;{})</span>
<span class="mf">2.</span> <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{})</span><span class="nx">简记为</span><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)=&gt;{})</span>
<span class="mf">3.</span> <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span> <span class="c1">// returns a already resolved promise</span>
    <span class="c1">// likewise, Promise.reject(reason) returns a already rejected promise</span>
<span class="p">})</span>
<span class="nx">简记为</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">})</span>
<span class="nx">所以</span><span class="err">：</span><span class="k">return</span> <span class="nx">val</span> <span class="o">&lt;=&gt;</span> <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">&lt;=&gt;</span> <span class="k">return</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span>
</pre>
<p>在ECMAScript 2017中，提供了更简洁的写法：（本质上是对上述写法的语法糖）</p>
<pre class="code literal-block"><span class="k">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">async_operations</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sync_or_async_ops</span><span class="p">(</span><span class="nx">reuslt</span><span class="p">);</span> 
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sync_or_async_ops</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">failureCallback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>除了.then规则，还有.all和.any, .race...本质上都是对<strong>各个操作间同步关系的描述</strong></p>
<p>例如：</p>
<pre class="code literal-block"><span class="nf">Promise.all</span><span class="p">([</span><span class="no">fn1</span><span class="p">,</span> <span class="no">fn2</span><span class="p">,</span> <span class="no">fn3</span><span class="p">,</span> <span class="no">fn4</span><span class="p">])</span>
<span class="na">.then</span><span class="p">(([</span><span class="no">res1</span><span class="p">,</span> <span class="no">res2</span><span class="p">,</span> <span class="no">res3</span><span class="p">,</span> <span class="no">res4</span><span class="p">])</span> <span class="err">=&gt;</span> <span class="err">{</span>
    <span class="nf">do</span> <span class="no">something</span>
<span class="err">})</span>

<span class="nf">Promise.all</span><span class="p">()</span>
</pre>
<h4 id="promise_2">那我们如何创建Promise呢</h4>
<p>例如：</p>
<pre class="code literal-block"><span class="kd">const</span> <span class="nx">wait</span> <span class="o">=</span> <span class="nx">ms</span> <span class="p">=&gt;</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span>
</pre>
<p>上述定义了一个wait的函数，该函数接受一个ms参数，返回一个Promise对象，其中Promise维护了操作"resolve =&gt; setTimeout(resolve, ms)"的执行情况，</p>
<p>当我们使用wait时，即</p>
<pre class="code literal-block"><span class="nx">wait</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomething</span><span class="p">)</span> <span class="o">&lt;=&gt;</span> <span class="ow">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">doSomething</span><span class="p">,</span> <span class="nx">ms</span><span class="p">))</span>
</pre>
<p>从而创建了一个setTimeout的wrapper.</p>
<p>总的来说，Promise的主要贡献在于优化了异步回调中臃肿不堪的语法</p>
<h3 id="_1">注意事项</h3>
<p>注意，Promise如果不进行异常捕获，如果执行过程出错，是不会造成程序终止的。</p>
</div>
                </div>
            </article>
</div>
    

    

    


        <!--End of body content-->

        <footer id="footer">
            Contents © 2021         <a href="mailto:heyuehuii@126.com">dagrons</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
