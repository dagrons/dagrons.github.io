<h2 id="redis">redis简介</h2>
<ul>
<li>redis是单进程, 单线程, 所以具有很好的同步能力</li>
<li>redis所有操作都是原子性的, 单个操作是原子性的, 多个操作也支持事务(通过MULTI和EXEC指令), 乍一看redis支持的数据类型也不特殊, 而其灵活性就来源于redis的操作原子性, 借助这个特性我们可以轻易实现分布式锁</li>
<li>redis是分布式通信的绝佳手段</li>
</ul>
<h2 id="redis_1">redis支持的数据类型</h2>
<ul>
<li>string: 最基础的数据类型, 二进制安全字符串, 存储图片等二进制格式需要存储base64编码</li>
<li>hash: 哈希</li>
<li>list: 列表</li>
<li>set: 集合</li>
<li>zset(sorted set): 有序集合</li>
</ul>
<h2 id="_1">悲观锁实现</h2>
<pre class="code literal-block"><span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">StrictRedis</span> 

<span class="n">redis_client</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">decode_response</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># StrictRedis 接口和命令行接口兼容</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">order_lock</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">setnx</span><span class="p">(</span><span class="s1">&#39;lock:order&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">redis_client</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s1">&#39;lock:order&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 设置过期时间防止死锁</span>
    <span class="k">if</span> <span class="n">order_lock</span><span class="p">:</span>
        <span class="n">reserve_count</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reserve_count&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">reserve_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">redis_client</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="s1">&#39;reserve_count&#39;</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;已下单&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;已告罄&#39;</span><span class="p">)</span>
        <span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;lock:order&#39;</span><span class="p">)</span>
        <span class="k">break</span>
</pre>
<h2 id="_2">乐观锁实现</h2>
<pre class="code literal-block"><span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">StrictRedis</span><span class="p">,</span> <span class="n">WatchError</span>

<span class="n">redis_client</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,)</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span> <span class="c1"># 管道用于打包多条无关命令批量执行, 用来提升性能</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>        
        <span class="n">pipe</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="s1">&#39;reserve_count&#39;</span><span class="p">)</span>        
        <span class="n">count</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reserve_count&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># 有库存, 让库存 -1            </span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">multi</span><span class="p">()</span>            
            <span class="n">pipe</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="s1">&#39;reserve_count&#39;</span><span class="p">)</span>            
            <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c1"># 会执行之前的所有命令</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;已下单&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;已售罄&#39;</span><span class="p">)</span>            
            <span class="n">pipe</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="n">WatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># 出现该异常, 说明监听的数据被修改了, 重试/取消</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;重试&#39;</span><span class="p">)</span>
</pre>
<h2 id="cheatsheet">Cheatsheet</h2>
<p><a href="https://www.runoob.com/w3cnote/python-redis-intro.html">runoob python redis</a></p>