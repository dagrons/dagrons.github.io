<h1 id="_1">问题分析：</h1>
<ol>
<li>首先通过crontab设置定时任务，将ip信息和gpu使用情况定时打到某文件中</li>
<li>通过one-shot-server创建服务</li>
</ol>
<h1 id="gpu">GPU使用情况脚本</h1>
<pre class="code literal-block"><span class="ch">#!/bin/bash</span>

<span class="nv">persons</span><span class="o">=()</span>
<span class="nv">usages</span><span class="o">=()</span>

<span class="k">for</span> t <span class="k">in</span> <span class="k">$(</span>nvidia-smi<span class="p">|</span>egrep <span class="s1">&#39;^\|[\ ]{4}[[:digit:]]&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;|&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $4}&#39;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="c1"># command substitution</span>
    <span class="nv">persons</span><span class="o">+=(</span><span class="s2">&quot;</span><span class="k">$(</span>cat /proc/<span class="nv">$t</span>/cgroup<span class="p">|</span>head -n <span class="m">1</span><span class="p">|</span>cut -d <span class="s1">&#39;.&#39;</span> -f <span class="m">3</span><span class="k">)</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="k">done</span>

<span class="k">for</span> t <span class="k">in</span> <span class="k">$(</span>nvidia-smi<span class="p">|</span>egrep <span class="s1">&#39;^\|[\ ]{4}[[:digit:]]&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;|&#39;</span><span class="p">|</span>awk <span class="s1">&#39;{print $7}&#39;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> 

    <span class="nv">usages</span><span class="o">+=(</span><span class="s2">&quot;</span><span class="nv">$t</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="k">done</span>

<span class="nv">plen</span><span class="o">=</span><span class="si">${#</span><span class="nv">persons</span><span class="p">[@]</span><span class="si">}</span> <span class="c1"># parameter expansion</span>

<span class="nb">echo</span> <span class="s2">&quot;------&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;usage:&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;------&quot;</span>
<span class="nb">echo</span> 
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;<span class="si">${</span><span class="nv">plen</span><span class="si">}</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span> <span class="c1"># arithemetic expansion</span>
    <span class="nb">printf</span> <span class="s2">&quot;%-10s\t | %10s\n&quot;</span> <span class="si">${</span><span class="nv">persons</span><span class="p">[i]</span><span class="si">}</span> <span class="si">${</span><span class="nv">usages</span><span class="p">[i]</span><span class="si">}</span>
<span class="k">done</span>
<span class="nb">echo</span> 
<span class="nb">echo</span> <span class="s2">&quot;update at </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;------------------------------&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;------------------------------&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> 
</pre>
<h1 id="ip">账号IP信息打印</h1>
<pre class="code literal-block">lxc list 
</pre>
<h1 id="crontab">crontab设置定时任务</h1>
<p>定时打印ip和gpu使用信息</p>
<pre class="code literal-block"><span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">status</span>
<span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">who_is_using_gpu</span><span class="o">.</span><span class="n">sh</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">usage</span>
<span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">who_is_using_gpu</span><span class="o">.</span><span class="n">sh</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">snap</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">lxc</span> <span class="n">list</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span> <span class="o">/</span><span class="n">dagongren</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ip</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">ip</span><span class="o">.</span><span class="n">html</span>
</pre>
<h1 id="one-shot-server">one-shot-server脚本</h1>
<pre class="code literal-block"><span class="c1">#/bin/bash</span>

<span class="nv">PORT</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">FILE</span><span class="o">=</span><span class="nv">$2</span>

<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;The file </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2"> does not exist&quot;</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;The file </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2"> does exist&quot;</span>
<span class="k">while</span> <span class="o">[[</span> <span class="m">1</span> <span class="o">]]</span>
<span class="k">do</span>
  <span class="o">{</span> <span class="nb">echo</span> -ne <span class="s2">&quot;HTTP/1.0 200 OK\r\nContent-Length: </span><span class="k">$(</span>wc -c &lt;<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="k">)</span><span class="s2">\r\n\r\n&quot;</span><span class="p">;</span> cat <span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="p">;</span> <span class="o">}</span> <span class="p">|</span> nc -l -p <span class="si">${</span><span class="nv">PORT</span><span class="si">}</span>
<span class="k">done</span>
</pre>
<h1 id="one-shot-server_1">通过one-shot-server启动服务</h1>
<blockquote>
<p>最好启动两次, 我也不知道为什么</p>
</blockquote>
<pre class="code literal-block">nohup bash ./one_shot_server <span class="m">8080</span> /root/share/ip &gt; /dev/null <span class="p">&amp;</span> 
</pre>