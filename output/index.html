<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="zh_cn">
<head>
<meta charset="utf-8">
<meta name="description" content="NuLL">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NuLL</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="zh_cn" href="rss.xml">
<link rel="canonical" href="https://dagrons.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/pythonduo-xian-cheng-xue-xi/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">跳到主内容</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">NuLL</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">文章归档</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">标签</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS 源</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/pythonduo-xian-cheng-xue-xi/" class="u-url">Python多线程学习</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/pythonduo-xian-cheng-xue-xi/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-13T21:43:08+08:00" itemprop="datePublished" title="2021-04-13 21:43">2021-04-13 21:43</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<blockquote>
<p>理解python docs，首先是Executor Objects, Thread/ProcessPoolExecutor, 然后是Module Functions, 最后是Exception classes，不止是学习API，还要了解它的思维框架</p>
</blockquote>
<h3>Intro</h3>
<p>The concurrent.futures module provides a high-level interface for asynchronously executing callables</p>
<p>keyword: callables, high-level</p>
<h3>基本框架</h3>
<pre class="code literal-block"><span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">future_to_url</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%r</span><span class="s1"> generated an exception: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%r</span><span class="s1"> page is </span><span class="si">%d</span><span class="s1"> bytes'</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
</pre>
<h3>提交任务</h3>
<pre class="code literal-block"><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="c1"># 创建并提交一个任务</span>
<span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">iterables</span><span class="p">)</span> <span class="c1"># 对iterables中每个值都创建并提交一个任务</span>
<span class="n">等价于</span><span class="p">:</span>
<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">iterables</span><span class="p">:</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre>
<h3>查询任务本身状态？</h3>
<pre class="code literal-block"><span class="n">future</span><span class="o">.</span><span class="p">[</span><span class="n">cancel</span><span class="p">(),</span> <span class="n">cancelled</span><span class="p">(),</span> <span class="n">running</span><span class="p">(),</span> <span class="n">done</span><span class="p">(),</span> <span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">exception</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)]</span>
</pre>
<h3>下班</h3>
<pre class="code literal-block"><span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 下班了!</span>
<span class="n">wait</span><span class="o">=</span><span class="n">True会等待所有工作做完</span><span class="err">，</span><span class="n">才下班</span>
</pre>
<h3>有趣的方法！</h3>
<pre class="code literal-block"><span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="n">fn的唯一参数为future</span>
</pre>
<blockquote>
<p>怀念js，怀念functional</p>
</blockquote>
<h3>Executor Objects</h3>
<p>abstract class: concurrent.futures.Executor(need to be implemented!)
继承关系：</p>
<blockquote>
<p>继承包含实现继承和接口继承</p>
</blockquote>
<pre class="code literal-block"><span class="n">Executor</span><span class="o">[</span><span class="n">abstract</span><span class="o">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Threadpoolexecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">[</span><span class="n">concrete</span><span class="o">]</span><span class="w"></span>
<span class="w">           </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Processpoolexecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">[</span><span class="n">concrete</span><span class="o">]</span><span class="w"></span>
</pre>
<h3>ThreadPool or ProcessPool?</h3>
<p>CPU bottleneck? =&gt; ProcessPool（亲测，如果是CPU bottleneck，要比ThreadPool快很多）</p>
<p>I/O bottleneck? =&gt; ThreadPool（如果bottleneck不在CPU上，就没必要用ProcessPool了，ThreadPool开销更小）</p>
<h3>Module Functions</h3>
<ol>
<li>等待所有任务完成？（注意：这会阻塞当前线程）</li>
</ol>
<pre class="code literal-block"><span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
<span class="sd">"""</span>
<span class="sd">return_when =&gt; </span>
<span class="sd">FIRST_COMPLETED: any future finishes or is cancelled</span>
<span class="sd">FIRST_EXCEPTION: any future finishes by raising an exception or all completed</span>
<span class="sd">ALL_COMPLETED: when all future finishes or cancelled</span>
<span class="sd">"""</span>
</pre>
<ol>
<li>获取所有已经完成的任务（或者已经被取消的任务）</li>
</ol>
<pre class="code literal-block"><span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre>
<h3>Exception Classes</h3>
<blockquote>
<p>异常是程序无法语料之事，已经无法继续运行，当异常出现时，可以通过两种方式修补，一是提前预防(pre-process)，一种是通过适当的逻辑进行修补，提前判断和过滤，第二种是亡羊补牢(post-process)，在异常发生后，通过try...except进行捕获与处理.</p>
</blockquote>
<pre class="code literal-block"><span class="mf">1.</span> <span class="n">CancelledError</span><span class="p">:</span> <span class="n">Raised</span> <span class="n">when</span> <span class="n">a</span> <span class="n">future</span> <span class="n">is</span> <span class="n">cancelled</span>
<span class="mf">2.</span> <span class="n">TimeoutError</span><span class="p">:</span> <span class="n">Raised</span> <span class="n">when</span> <span class="n">a</span> <span class="n">future</span> <span class="n">operation</span> <span class="n">exceeds</span> <span class="n">the</span> <span class="n">given</span> <span class="n">timeout</span>
<span class="mf">3.</span> <span class="n">BrokenError</span><span class="p">:</span> <span class="n">Derived</span> <span class="n">from</span> <span class="kr">Run</span><span class="n">timeError</span><span class="p">,</span> <span class="n">raised</span> <span class="n">when</span> <span class="n">a</span> <span class="n">executor</span> <span class="n">is</span> <span class="n">broken</span> <span class="kr">for</span> <span class="n">some</span> <span class="n">reason</span>
<span class="mf">4.</span> <span class="n">InvalidStateError</span><span class="p">:</span> <span class="n">an</span> <span class="n">operation</span> <span class="n">is</span> <span class="n">performed</span> <span class="kr">on</span> <span class="n">future</span> <span class="n">that</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">allowed</span> <span class="n">in</span> <span class="n">the</span> <span class="n">curren</span> <span class="n">state</span>
<span class="mf">5.</span> <span class="n">BrokenThreadPool</span><span class="p">:</span> <span class="n">when</span> <span class="kr">on</span><span class="n">e</span> <span class="n">of</span> <span class="n">the</span> <span class="n">workers</span> <span class="n">of</span> <span class="n">a</span> <span class="n">ThreadPoolexecutor</span> <span class="n">has</span> <span class="n">failed</span> <span class="n">initializing</span>
<span class="mf">6.</span> <span class="n">BrokenProcessPool</span><span class="p">:</span> <span class="n">when</span> <span class="kr">on</span><span class="n">e</span> <span class="n">of</span> <span class="n">the</span> <span class="n">workers</span> <span class="n">of</span> <span class="n">Processpoolexecutor</span> <span class="n">has</span> <span class="n">failed</span> <span class="n">initializing</span>
</pre>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/zwkxian-duan-shu-zhe-mo-ri-ji/" class="u-url">zwk线段树折磨日记</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/zwkxian-duan-shu-zhe-mo-ri-ji/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-11T14:42:47+08:00" itemprop="datePublished" title="2021-04-11 14:42">2021-04-11 14:42</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<p><strong>前言：我为什么要学线段树</strong></p>
<blockquote>
<p>老实讲，学线段树只是最近看到了zwk大佬的动态，然后去搜了一下这个人，发现他有个zwk线段树，于是觉得很感兴趣，就下载了他的课件去探究，发现真的和大佬的世界差距太多了，深深感受到智商的碾压！</p>
</blockquote>
<p><strong>一些基础知识</strong></p>
<ol>
<li>常见的树结构存储方式：堆式存储（建立存储位置和逻辑位置的关系/多用于满二叉树或 可以满二叉树的情况），链式存储（这个就不说了）</li>
<li>树结构的根节点存储位置常从1开始，用0表示非法值</li>
<li>对于堆结构的树，s和s^1互为兄弟节点，可以用s^t^1判断两个节点是否是兄弟节点</li>
<li>一个节点的左儿子是s&gt;&gt;1，右节点是s&gt;&gt;1|1</li>
<li>左儿子存储位置为偶数，右儿子存储位置为奇数，因此~s^1可以判断是左节点，s^1判断右节点</li>
</ol>
<p><strong>线段树？</strong></p>
<p>解决区间查询，区间修改问题</p>
<p><strong>思想？</strong></p>
<p>二分，将区间信息组织成树状形式，父节点维护的信息就是子节点的合并</p>
<p><strong>那？zwk线段树？</strong></p>
<p>传统线段树常数较大，实现复杂，而且是Top-down Approach，zwk使用Bottom-up的方式，利用堆式结构进行存储，常数更小</p>
<p><strong>How?</strong></p>
<pre class="code literal-block"><span class="c1">// .data</span>
<span class="kt">int</span> <span class="n">q</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">// 根节点为1</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">M</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="c1">// M为维护的区间大小</span>

<span class="c1">// build</span>
<span class="kt">void</span> <span class="nf">build</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">M</span><span class="mi">-1</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span> 
<span class="p">}</span>

<span class="c1">// query：查询[s, t]</span>
<span class="c1">// 只能查询[1, 2^n-2]的区间</span>
<span class="c1">// s和s^1互为兄弟节点</span>
<span class="c1">// s^t^1判断s和t是否是兄弟节点，s^t^1 == 0 &lt;=&gt; s^1 == t，注意，异或具有交换律</span>
<span class="kt">int</span> <span class="nf">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="n">M</span><span class="mi">-1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="o">^</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="n">ans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="n">ans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// modify: 单点修改</span>
<span class="kt">void</span> <span class="nf">modify</span><span class="p">(</span><span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">+=</span><span class="n">m</span><span class="p">]</span><span class="o">=</span><span class="n">val</span><span class="p">;</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
</pre>
<p><strong>完了吗？</strong></p>
<p>没有，还有区间修改呢！</p>
<p><strong>How？</strong></p>
<p>懒标记！不知道？先去看https://oi-wiki.org/ds/seg/吧</p>
<p>懒标记成功地减少了pushdown的次数，只在需要的时候才pushdown，复杂度为O(logn)</p>
<p><strong>等等，我们不是Bottom-up吗？</strong></p>
<p>是的，但我们依然可以使用懒标记和Top-down来更新懒标记啊！</p>
<p><strong>但是！我们有更好的方法</strong></p>
<p>Bottom-up就要Bottom-up到底！</p>
<p>其实区间修改和区间查询的过程是差不多的，都是对区间相应节点的遍历</p>
<p>我们考虑标记，标记是什么，标记是父节点对子节点的相对值！</p>
<p><strong>等等，有了相对值，我们还需要绝对值干嘛</strong></p>
<p>如果我们让所有节点的值从0开始，那不就不需要绝对值了嘛，那我们在每个节点还存绝对值干嘛，只存一个标记就行了嘛！</p>
<p>嗯，标记是父节点对子节点的相对值，这对Top-down的过程很好，那对Bottom-up呢？</p>
<p>那我们就存子节点对父节点的相对值？</p>
<p><strong>好了， 我们来捋一捋</strong></p>
<p>假设我们有三个节点：f, l, r，其中f为父节点，l和r为子节点，假设他们的标签值为x, y, z，即l的最大值比f大y，r的最大值比f大z，f比他父亲大x</p>
<p>那我们如何知道f的最大值究竟是多少呢，应该是(T[f] + T[f&gt;&gt;1] + ... T[1]) + 所有子节点区间相对于f的最大值，对于前者，我们只需要向上遍历即可求出，那对于后者？我们不可能去遍历所有的可能路径吧。。。。</p>
<p><strong>除非？？？我们在每一次向上修改时，都保证每个节点存储的是子树区间的相对最大值？</strong></p>
<p><strong>什么意思？</strong></p>
<pre class="code literal-block"><span class="n">A</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
</pre>
<p>在向上修改的过程中，通过上述操作，我们保证了每一个节点的值都是所有构成子区间的相对最大值！更细的也不好解释了，建议多画画图去体会。。。</p>
<p><strong>好了，我们来看一下完整的代码</strong></p>
<pre class="code literal-block"><span class="c1">// 区间修改</span>
<span class="kt">void</span> <span class="nf">modify</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="n">M</span><span class="mi">-1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="o">^</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]),</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 区间查询</span>
<span class="kt">int</span> <span class="nf">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">lans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">+</span><span class="n">M</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">M</span><span class="p">;</span> <span class="n">s</span><span class="o">^</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">rans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">s</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="n">lans</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">lans</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">^</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="n">rans</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">rans</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="o">^</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">lans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">rans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">t</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">ans</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">lans</span><span class="p">,</span> <span class="n">rans</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="n">ans</span> <span class="o">+=</span> <span class="n">q</span><span class="p">[</span><span class="n">s</span><span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p><strong>OK, 完了？</strong>*</p>
<p>完了...</p>
<p><strong>参考</strong></p>
<p>zwk-《the power of statistics》</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/torch/" class="u-url">torch</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/torch/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-08T22:58:49+08:00" itemprop="datePublished" title="2021-04-08 22:58">2021-04-08 22:58</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <p>在这里书写你的文章。</p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/components-state-machine-state-events-action/" class="u-url">Components, State machine, state, events, action</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/components-state-machine-state-events-action/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-05T20:37:29+08:00" itemprop="datePublished" title="2021-04-05 20:37">2021-04-05 20:37</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Intro</h2>
<p>The world is a state machine driven by events</p>
<p>events are what components listening on</p>
<p>components responds to different events with different actions</p>
<p>different components cares only about events they listen on</p>
<p>state are what the actions condition on</p>
<p>Event handlers are actions registered on a event</p>
<p>some components share on some state while some do not</p>
<p>the actions of one components may affect the states of other components</p>
<p>the actions of one component can emit events to others.</p>
<p>It's always a bad practice for one component to emit events to itself.</p>
<p>in real world, all components runs on different thread, however it's not true in programming</p>
<h2>Event</h2>
<p>Understanding the capture phrase and bubble phrase of event passing, we can choose to register our event listener on the capture phrase or bubble phrase with the third optional parameter which is default to false(bubble)</p>
<p>We can use e.target to refer to the event target component and use e.srcElement to refer to the source component, however there may be no srcElement for some events such as ajax events.</p>
<p>event can be created with </p>
<pre class="code literal-block"><span class="nx">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Event</span><span class="p">(</span><span class="nx">typeArg</span><span class="p">,</span> <span class="nx">eventInit</span><span class="p">);</span>
</pre>
<p>some important APIs for events are stopPropagation and preventDefault </p>
<h2>ICC (Inter Component Communication)</h2>
<p>Shared state: If A and B share some same state, it's ok to operate on the state directly</p>
<p>Function as args: A can pass a encapsulated function for B to call, executed immediately</p>
<p>Emit a event: A can emit a event to B to trigger B's event listener, not executed immediately</p>
<p>Children -&gt; parent: parent pass function to children as props/args, be careful to bind "this"!</p>
<p>Parent -&gt; children: props/args</p>
<p>Child &lt;-&gt; Child: shared context/state</p>
<p>The third approach is not recommended</p>
<h2>React</h2>
<blockquote>
<p>useState, useEffect, useReducer, when and why?</p>
</blockquote>
<p>in react, "state" are special state do something with ui behaviors, and can only be changed with setState, which will not be executed immediately, but will be changed in order they been pushed into the queue(which is synchronous opeation)
in other words, react "state" is what render action conditions on.</p>
<p>react "state" are not recommended when the next value depends on the previous value.</p>
<pre class="code literal-block"><span class="nv">suppose</span> <span class="nv">A</span> <span class="nv">component</span> <span class="nv">has</span> <span class="nv">a</span> <span class="nv">state</span> <span class="nv">binary</span> <span class="ss">(</span><span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="ss">)</span>, <span class="k">if</span> <span class="nv">the</span> <span class="nv">only</span> <span class="nv">actions</span> <span class="nv">the</span> <span class="nv">component</span> <span class="k">do</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">state</span> <span class="nv">is</span> <span class="nv">to</span> <span class="nv">invert</span> <span class="nv">it</span>, 
<span class="nv">A</span> : 
<span class="nv">Invert</span> <span class="o">=&gt;</span> <span class="k">if</span> <span class="nv">binary</span> <span class="o">==</span> <span class="mi">1</span>: <span class="nv">setBinary</span> <span class="ss">(</span><span class="mi">0</span><span class="ss">)</span> <span class="k">else</span> <span class="nv">setBinary</span> <span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>

<span class="nv">As</span> <span class="nv">we</span> <span class="nv">already</span> <span class="nv">know</span>, <span class="nv">setBinary</span> <span class="nv">are</span> <span class="nv">not</span> <span class="nv">executed</span> <span class="nv">immediately</span>, <span class="nv">instead</span>, <span class="nv">they</span> <span class="nv">are</span> <span class="nv">pushed</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">queue</span> <span class="nv">in</span> <span class="nv">order</span>
<span class="k">If</span> <span class="nv">A</span> <span class="nv">invert</span> <span class="nv">Binary</span> <span class="nv">twice</span> <span class="nv">when</span> <span class="nv">binary</span><span class="o">==</span><span class="mi">1</span>, <span class="nv">what</span> <span class="nv">we</span> <span class="nv">expected</span> <span class="nv">finally</span> <span class="nv">is</span> <span class="nv">bianry</span> <span class="o">==</span> <span class="mi">1</span>
<span class="nv">However</span>, <span class="k">if</span> <span class="nv">the</span> <span class="nv">second</span> <span class="nv">invert</span> <span class="nv">happens</span> <span class="nv">before</span> <span class="nv">the</span> <span class="nv">setState</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">first</span> <span class="nv">invert</span> <span class="nv">been</span> <span class="nv">executed</span>. <span class="k">Then</span> <span class="nv">the</span> <span class="nv">binary</span> <span class="nv">would</span> <span class="nv">be</span> <span class="mi">0</span> <span class="nv">in</span> <span class="nv">the</span> <span class="k">end</span>, <span class="nv">not</span> <span class="nv">as</span> <span class="nv">we</span> <span class="nv">expected</span>.
</pre>
<p>To solve the above problem, we should useReducer.</p>
<pre class="code literal-block">const binary = {value: 0};

function reducer(state, action) {
  switch (action.type) {
    case 'invert':
      return {count: state.value^1};
    default:
      throw new Error();
  }
}

function Inverter() {
  const [state, dispatch] = useReducer(reducer, 1);
  return (
    <span class="err">&lt;</span>&gt;
      binary: {state.value}
      <span class="nt">&lt;button</span> <span class="na">onClick=</span><span class="s">{()</span> <span class="err">=</span><span class="nt">&gt;</span> dispatch({type: 'invert'})}&gt;invert<span class="nt">&lt;/button&gt;</span>
    <span class="err">&lt;</span>/&gt;
  );
}
</pre>
<p>the dispatched actions are pushed into the queue and ensured to  be executed in FIFO order.</p>
<p>Do not useReducer if useState works.</p>
<p>in react, useEffect defined what to execute after first render when or react "state" changes.</p>
<p>in react, components are organized in a tree structure, each components is a node on the tree.</p>
<p>in react, each components have at least one action called render, which listen on render events.</p>
<p><img alt="事件，状态，动作" src="images/QQ%E6%88%AA%E5%9B%BE20210405222133.png"><img alt="共享状态-组件通信" src="images/QQ%E6%88%AA%E5%9B%BE20210405213404.png"><img alt="React树形结构" src="images/QQ%E6%88%AA%E5%9B%BE20210405222359.png"></p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/yi-xie-jing-yan/" class="u-url">一些经验</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/yi-xie-jing-yan/" rel="bookmark">
            <time class="published dt-published" datetime="2021-04-01T14:11:48+08:00" itemprop="datePublished" title="2021-04-01 14:11">2021-04-01 14:11</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>misc</h2>
<ol>
<li>用git管理项目，追溯代码的变化，一方面可以回溯，一方面可以检查bug是如何产生的 </li>
<li>层次感，结构感，流程清晰，注释详尽</li>
</ol>
<h2>S端</h2>
<ol>
<li>后端开发对于简单事务的路由封装很容易，但涉及到并发，同步，IPC，任务队列，负载均衡，数据库同步，横向扩展就会变得十分麻烦</li>
<li>尽量把数据库，虚拟机，docker放在服务器，不然把本地很快就会变得十分卡顿，尤其是涉及到文件读写和HTTP请求时</li>
</ol>
<h2>C端</h2>
<ol>
<li>对于SPA而，，多用development server + proxy代理进行测，，没必要部署到server，费时费力，而且修改麻烦</li>
<li>前端的模型是一棵树，不同的组件挂载到不同的节点，重点是处理路由，组件通信，以及节点本身的状态机模型</li>
<li>对于js，应该尽量避免this和class</li>
<li>前端和后端有个非常不同的点，就是前端开发应用层的代码逻辑很容易就变得极其复杂，而后端的复杂逻辑主要集中在和业务正交的领域</li>
</ol>
<h2>对抗复杂性的方法</h2>
<ol>
<li>封装，对外只暴漏接口和方法</li>
<li>多态，对于同一方法，根据类型不同而使用不同的实现</li>
<li>继承，包括实现继承和接口继承，两者的目的是不一样的，实现继承是为了代码复用，接口继承并没有复用代码，而是需要自己实现相应的接口函数，接口继承的目的是为了实现抽象，继承响应的接口并实现它们以实现对其他组件的拔插，注意，在支持duck type的语言中，没有显式的接口声明</li>
</ol>
<pre class="code literal-block">&gt;在C++中，使用abstract class对应接口继承，使用class对应实现继承，有的abstract class既有接口继承也有实现继承，其中virtual function对应接口继承，在ruby，python中，由于使用duck type，没有显式的接口声明，而ruby使用class和maxin对应实现继承，python使用class对应实现继承
&gt;python和C++都有多继承，要注意菱形继承的问题
</pre>
<ol>
<li>Convention over configuration，除非用户指定，否则使用默认的配置，让组件使用者只关心它关心的接口参数</li>
<li>使用树形结构或嵌套结构增强层次感和结构感，隐藏细节</li>
<li>框架就是对于某一类任务提供的各种封装好的工具库，接口以及实现</li>
</ol>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/jszhong-de-promiseji-zhi/" class="u-url">js中的promise机制</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        dagrons
                    </span></p>
            <p class="dateline">
            <a href="posts/jszhong-de-promiseji-zhi/" rel="bookmark">
            <time class="published dt-published" datetime="2021-03-23T11:18:42+08:00" itemprop="datePublished" title="2021-03-23 11:18">2021-03-23 11:18</time></a>
            </p>
                </div>
            </header><div class="e-content entry-content">
                    <div>
<h2>Js中的核心机制-Promise</h2>
<p>“在异步中实现同步”</p>
<p>如果说js中有什么东西造就了他的与众不同，我想，既不是functional programming这种几十年前的老东西，也不是None和undefined这种奇怪的机制，甚至于this的dynamic scope都不足以支撑js成为一门与众不同而独占前端市场的语言，而是他的异步机制，js是专为异步编程设计的语言，不只是体现在语法上，更重要的是其提供的基建。</p>
<p>在前端开发中，相当大的一部分工作是在进行UI渲染和回调处理，这不仅是web独有的特点，而是针对几乎所有前端开发的共有特性，在前端逻辑中，我们经常关注于一个按钮被点击后会发生什么，当我们从服务器中获取数据后要干什么...，于是有了“事件流”的概念，我们将事件流想象成一个队列，主线程从事件流中不断取出事件，并进行处理。</p>
<p>这里涉及两个问题，1. 主线程如何根据事件确定相应的处理逻辑？2. 主线程如何确保处理逻辑不会阻塞</p>
<p>对于问题1，js中提供了相当多的机制，典型的例子就是DOM的事件监听机制，用户在各种事件上注册各种处理函数，从而确定事件对应的处理逻辑，还例如fetch的回调，用于执行fetch返回后的处理逻辑</p>
<p>对于问题2，主线程如何确保处理逻辑不会阻塞，首先，我们要时刻谨记“js是单线程的”，也就是说，所有的操作都在一个线程内完成，这似乎很难理解，但回到我们之前的事件流模型，就不难发现，整个程序所做的事件不过是：</p>
<pre class="code literal-block"><span class="k">while</span> <span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">pop_front</span><span class="p">();</span>
    <span class="nx">handle</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>虽然js是单线程的，但浏览器并非单线程，浏览器只是为每个window开一个js线程，一个UI渲染引擎。</p>
<p>既然js是单线程的语言，所以要求我们的事件处理函数一定是不能阻塞我们的主线程，其中UI渲染事件会被交给UI渲染引擎进行处理，而fetch和setTimeout,setInterval，以及DOM的各种OnXXX事件，如何保证它们被处理的时候不阻塞呢，答案是：异步/non-blocking</p>
<p>在js中，异步/non-blocking常与Promise挂钩</p>
<h3>Promise</h3>
<p>在js中，异步/non-blocking的含义就是将一个同步的过程分解成几个步骤，使得原来阻塞的处理逻辑变得不阻塞，举个例子：我们想要从server端获取数据，然后进行处理，但从server端获取数据的过程是会产生阻塞的，于是js提出了promise机制，首先它让fetch变成non-blocking的调用，然后允许我们对fetch的返回数据注册处理函数，但是这个处理函数是在fetch的返回数据确定后执行</p>
<p>所以，什么是Promise机制呢：</p>
<h4>Promise维护了操作的执行信息</h4>
<p>用mdn上的话说：</p>
<blockquote>
<p>A Promise is an object representing the eventual completion or failure of an asynchronous operation.</p>
</blockquote>
<p>也就是说Promise维护了异步操作执行情况的相关信息，pending, fullfilled, rejected</p>
<p>那除此之外呢？</p>
<h4>Promise提供了一套描述aysn_ops间执行关系的语言</h4>
<p>Promise提供了一套Chain规则，让我们方便地描述异步操作的执行过程</p>
<p>如下：</p>
<pre class="code literal-block"><span class="nx">asyn_operations</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">successCallback</span><span class="p">,</span> <span class="nx">failureCallback</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">successCallback</span><span class="p">,</span> <span class="nx">failureCallback</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
<span class="p">...</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">failureCallback</span><span class="p">)</span>

<span class="nx">注意</span><span class="err">：</span><span class="nx">其中</span>
<span class="mf">1.</span> <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)=&gt;{},</span> <span class="kc">null</span><span class="p">)</span><span class="nx">简记为</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)=&gt;{})</span>
<span class="mf">2.</span> <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{})</span><span class="nx">简记为</span><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)=&gt;{})</span>
<span class="mf">3.</span> <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span> <span class="c1">// returns a already resolved promise</span>
    <span class="c1">// likewise, Promise.reject(reason) returns a already rejected promise</span>
<span class="p">})</span>
<span class="nx">简记为</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nx">doSomething</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">})</span>
<span class="nx">所以</span><span class="err">：</span><span class="k">return</span> <span class="nx">val</span> <span class="o">&lt;=&gt;</span> <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">&lt;=&gt;</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span>
</pre>
<p>在ECMAScript 2017中，提供了更简洁的写法：（本质上是对上述写法的语法糖）</p>
<pre class="code literal-block"><span class="k">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">async_operations</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sync_or_async_ops</span><span class="p">(</span><span class="nx">reuslt</span><span class="p">);</span> 
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sync_or_async_ops</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">failureCallback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
<p>除了.then规则，还有.all和.any, .race...本质上都是对<strong>各个操作间同步关系的描述</strong></p>
<p>例如：</p>
<pre class="code literal-block"><span class="nf">Promise.all</span><span class="p">([</span><span class="no">fn1</span><span class="p">,</span> <span class="no">fn2</span><span class="p">,</span> <span class="no">fn3</span><span class="p">,</span> <span class="no">fn4</span><span class="p">])</span>
<span class="na">.then</span><span class="p">(([</span><span class="no">res1</span><span class="p">,</span> <span class="no">res2</span><span class="p">,</span> <span class="no">res3</span><span class="p">,</span> <span class="no">res4</span><span class="p">])</span> <span class="err">=&gt;</span> <span class="err">{</span>
    <span class="nf">do</span> <span class="no">something</span>
<span class="err">})</span>

<span class="nf">Promise.all</span><span class="p">()</span>
</pre>
<h4>那我们如何创建Promise呢</h4>
<p>例如：</p>
<pre class="code literal-block"><span class="kd">const</span> <span class="nx">wait</span> <span class="o">=</span> <span class="nx">ms</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span>
</pre>
<p>上述定义了一个wait的函数，该函数接受一个ms参数，返回一个Promise对象，其中Promise维护了操作"resolve =&gt; setTimeout(resolve, ms)"的执行情况，</p>
<p>当我们使用wait时，即</p>
<pre class="code literal-block"><span class="nx">wait</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomething</span><span class="p">)</span> <span class="o">&lt;=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">doSomething</span><span class="p">,</span> <span class="nx">ms</span><span class="p">))</span>
</pre>
<p>从而创建了一个setTimeout的wrapper.</p>
<p>总的来说，Promise的主要贡献在于优化了异步回调中臃肿不堪的语法</p>
<h3>注意事项</h3>
<p>注意，Promise如果不进行异常捕获，如果执行过程出错，是不会造成程序终止的。</p>
</div>
                </div>
            </article>
</div>
    

    

    


        <!--End of body content-->

        <footer id="footer">
            Contents © 2021         <a href="mailto:heyuehuii@126.com">dagrons</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
